<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Xiang2023 Exp1 Round3 Modeling in Memo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-838cb846b2414f11caac439a21f6b75f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#helper-functions-jax-compatible" id="toc-helper-functions-jax-compatible" class="nav-link" data-scroll-target="#helper-functions-jax-compatible">Helper Functions (JAX-compatible)</a></li>
  <li><a href="#bayesian-inference-over-agent-strengths" id="toc-bayesian-inference-over-agent-strengths" class="nav-link" data-scroll-target="#bayesian-inference-over-agent-strengths">Bayesian Inference Over Agent Strengths</a></li>
  <li><a href="#game-theoretic-joint-optimization-of-effort" id="toc-game-theoretic-joint-optimization-of-effort" class="nav-link" data-scroll-target="#game-theoretic-joint-optimization-of-effort">Game-Theoretic Joint Optimization of Effort</a></li>
  <li><a href="#running-the-model-for-a-scenario" id="toc-running-the-model-for-a-scenario" class="nav-link" data-scroll-target="#running-the-model-for-a-scenario">Running the Model for a Scenario</a>
  <ul class="collapse">
  <li><a href="#visualization-of-inferred-strength" id="toc-visualization-of-inferred-strength" class="nav-link" data-scroll-target="#visualization-of-inferred-strength">Visualization of inferred strength</a></li>
  </ul></li>
  <li><a href="#compute-predictions-for-all-scenarios" id="toc-compute-predictions-for-all-scenarios" class="nav-link" data-scroll-target="#compute-predictions-for-all-scenarios">Compute predictions for all scenarios</a></li>
  <li><a href="#notes-on-conversion-strategy" id="toc-notes-on-conversion-strategy" class="nav-link" data-scroll-target="#notes-on-conversion-strategy">Notes on Conversion Strategy</a>
  <ul class="collapse">
  <li><a href="#probabilistic-inference-vs.-decision-theory" id="toc-probabilistic-inference-vs.-decision-theory" class="nav-link" data-scroll-target="#probabilistic-inference-vs.-decision-theory">1. Probabilistic Inference vs.&nbsp;Decision Theory</a></li>
  <li><a href="#key-conversion-decisions" id="toc-key-conversion-decisions" class="nav-link" data-scroll-target="#key-conversion-decisions">2. Key Conversion Decisions</a></li>
  <li><a href="#computational-considerations" id="toc-computational-considerations" class="nav-link" data-scroll-target="#computational-considerations">3. Computational Considerations</a></li>
  <li><a href="#what-could-be-improved" id="toc-what-could-be-improved" class="nav-link" data-scroll-target="#what-could-be-improved">4. What Could Be Improved</a></li>
  </ul></li>
  <li><a href="#how-to-compare-outputs" id="toc-how-to-compare-outputs" class="nav-link" data-scroll-target="#how-to-compare-outputs">How to Compare Outputs</a></li>
  <li><a href="#notes-on-the-alternative-models" id="toc-notes-on-the-alternative-models" class="nav-link" data-scroll-target="#notes-on-the-alternative-models">Notes on the alternative models</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Xiang2023 Exp1 Round3 Modeling in Memo</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Code adapted from https://github.com/jczimm/competence_effort/blob/main/Code/main_text/exp1_simulation.R</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="ef3054e3" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> memo <span class="im">import</span> memo</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Model parameters (from original WebPPL code)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">13.5</span>  <span class="co"># effort cost coefficient, from original paper; kept fixed for replication</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>beta <span class="op">=</span> <span class="fl">24.5</span>   <span class="co"># inequality aversion coefficient, from original paper; kept fixed for replication</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>weight_box <span class="op">=</span> <span class="dv">5</span>  <span class="co"># weight of the box</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>low_reward <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>high_reward <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Discretized spaces (for computational tractability)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>efforts <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.3</span>, <span class="fl">0.35</span>, <span class="fl">0.4</span>, <span class="fl">0.45</span>, <span class="fl">0.5</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">0.55</span>, <span class="fl">0.6</span>, <span class="fl">0.65</span>, <span class="fl">0.7</span>, <span class="fl">0.75</span>, <span class="fl">0.8</span>, <span class="fl">0.85</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">1.0</span>])</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Discretized strength space (replacing continuous uniform(1,10))</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>strength_values <span class="op">=</span> np.linspace(<span class="fl">1.</span>, <span class="fl">10.</span>, <span class="dv">301</span>) <span class="co"># [1,10] with step size of .03</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>DEBUG <span class="op">=</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="helper-functions-jax-compatible" class="level2">
<h2 class="anchored" data-anchor-id="helper-functions-jax-compatible">Helper Functions (JAX-compatible)</h2>
<div id="4ac50f3e" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lift(strength, effort):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Single agent lift: can they lift the box?"""</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (effort <span class="op">*</span> strength <span class="op">&gt;=</span> weight_box).astype(<span class="bu">float</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lift2(strength1, strength2, effort1, effort2, model_features):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Two-agent joint lift: can they lift the box together?"""</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="fl">3.5</span> <span class="co"># from original paper; kept fixed for replication</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.lax.cond(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        ModelFeatures.SAFE <span class="kw">in</span> model_features,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: (effort1<span class="op">*</span>strength1 <span class="op">+</span> effort2<span class="op">*</span>strength2) <span class="op">&gt;=</span> (weight_box <span class="op">+</span> ((<span class="dv">1</span><span class="op">-</span>effort1)<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>effort2))<span class="op">*</span>k),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: (effort1 <span class="op">*</span> strength1 <span class="op">+</span> effort2 <span class="op">*</span> strength2 <span class="op">&gt;=</span> weight_box),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        operand<span class="op">=</span><span class="va">None</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="bu">float</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gini(effort1, effort2):</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gini coefficient for inequality aversion"""</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.where(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        np.<span class="bu">abs</span>(effort1 <span class="op">-</span> effort2) <span class="op">&lt;</span> <span class="fl">1e-8</span>, <span class="co"># instead of effort1 == effort2 (to bypass floating point error)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.0</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        np.<span class="bu">abs</span>(effort1 <span class="op">-</span> effort2) <span class="op">/</span> <span class="dv">4</span> <span class="op">/</span> (effort1 <span class="op">+</span> effort2)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="bayesian-inference-over-agent-strengths" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-inference-over-agent-strengths">Bayesian Inference Over Agent Strengths</h2>
<p>The original WebPPL code infers agent strengths from observed outcomes in rounds 1 and 2.</p>
<div id="656e49f3" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> argmax_utility(strength, reward, effort_space<span class="op">=</span>efforts):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Find effort that maximizes utility for single agent"""</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    utilities <span class="op">=</span> reward <span class="op">*</span> lift(strength, effort_space) <span class="op">-</span> alpha <span class="op">*</span> effort_space</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> effort_space[np.argmax(utilities)]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outcome(strength, reward):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted outcome (success probability) for single agent at optimal effort"""</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    opt_effort <span class="op">=</span> argmax_utility(strength, reward)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lift(strength, opt_effort)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="at">@memo</span>(save_comic<span class="op">=</span><span class="st">"memo-comic-xiang-strength-inference"</span>, debug_trace<span class="op">=</span>DEBUG)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> infer_strengths[query_sa: strength_values, query_sb: strength_values](</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    r1_outcome_a, r1_outcome_b, r2_outcome_a, r2_outcome_b</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Infer posterior distribution over agent strengths given observed outcomes.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Observations:</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    - Round 1 (low reward = 10): A and B each attempt individual lifts</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    - Round 2 (high reward = 20): A and B each attempt individual lifts</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: Pr[strength_a == query_sa AND strength_b == query_sb | observations]</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The participant models that the agents have some strength in [1, 10]</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    participant: thinks[</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        agent_a: given(sa <span class="kw">in</span> strength_values, wpp<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        agent_b: given(sb <span class="kw">in</span> strength_values, wpp<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Participant witnesses the outcomes and conditions on them</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Condition on round 1 outcomes (low reward)</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    participant: observes_that [outcome(agent_a.sa, {low_reward}) <span class="op">==</span> r1_outcome_a]</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    participant: observes_that [outcome(agent_b.sb, {low_reward}) <span class="op">==</span> r1_outcome_b]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Condition on round 2 outcomes (high reward)</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    participant: observes_that [outcome(agent_a.sa, {high_reward}) <span class="op">==</span> r2_outcome_a]</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    participant: observes_that [outcome(agent_b.sb, {high_reward}) <span class="op">==</span> r2_outcome_b]</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Push query variables into participant frame </span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and return participant's estimate of the posterior probability for the agents having these given (query) strengths</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    participant: knows(query_sa)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    participant: knows(query_sb)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> participant[Pr[agent_a.sa <span class="op">==</span> query_sa <span class="kw">and</span> agent_b.sb <span class="op">==</span> query_sb]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="game-theoretic-joint-optimization-of-effort" class="level2">
<h2 class="anchored" data-anchor-id="game-theoretic-joint-optimization-of-effort">Game-Theoretic Joint Optimization of Effort</h2>
<p>The original WebPPL code models:</p>
<ol type="1">
<li>Two agents with uncertain strengths (posterior distributions from rounds 1-2)</li>
<li>Agents reason about each otherâ€™s efforts in round 3 (joint task)</li>
<li>Iterative best-response until Nash equilibrium</li>
<li>Optimization over initial effort to maximize joint utility</li>
</ol>
<p><strong>Key insight</strong>: The game-theoretic reasoning operates on <em>expected utilities</em> over the posterior distribution of strengths. This is not purely probabilistic reasoning (like the inference above), but rather decision-theoretic optimization under uncertainty.</p>
<p><strong>Proposed approach</strong>:</p>
<ul>
<li>Keep the Bayesian inference in <code>@memo</code> (already done above)</li>
<li>Implement the game-theoretic equilibrium finding in pure JAX (deterministic optimization)</li>
<li>Combine them: compute equilibrium for each strength pair, weighted by posterior</li>
</ul>
<div id="8de82765" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Flag, auto</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelFeatures(Flag):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    NONE <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    GINI <span class="op">=</span> auto()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    SAFE <span class="op">=</span> auto()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lift2(strength1, strength2, effort1, effort2, model_features):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Two-agent joint lift: can they lift the box together?"""</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="fl">3.5</span> <span class="co"># from original paper; kept fixed for replication</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.lax.cond(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        ModelFeatures.SAFE <span class="kw">in</span> model_features,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: (effort1<span class="op">*</span>strength1 <span class="op">+</span> effort2<span class="op">*</span>strength2) <span class="op">&gt;=</span> (weight_box <span class="op">+</span> ((<span class="dv">1</span><span class="op">-</span>effort1)<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>effort2))<span class="op">*</span>k),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: (effort1 <span class="op">*</span> strength1 <span class="op">+</span> effort2 <span class="op">*</span> strength2 <span class="op">&gt;=</span> weight_box),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        operand<span class="op">=</span><span class="va">None</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="bu">float</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gini(effort1, effort2):</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Gini coefficient for inequality aversion"""</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.where(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        np.<span class="bu">abs</span>(effort1 <span class="op">-</span> effort2) <span class="op">&lt;</span> <span class="fl">1e-8</span>, <span class="co"># instead of effort1 == effort2 (to bypass floating point error)</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.0</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        np.<span class="bu">abs</span>(effort1 <span class="op">-</span> effort2) <span class="op">/</span> <span class="dv">4</span> <span class="op">/</span> (effort1 <span class="op">+</span> effort2)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> outcome2(strength_a, strength_b, effort_a, effort_b, model_features):</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted outcome (success probability) for joint action"""</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.ndim(strength_a) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># translation of listMean(map2(function(i,j){return lift2(i,j,box,effort,effort2)}, strength,strength2))</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># note that map2 maps over the input arrays *concurrently*</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        outcomes <span class="op">=</span> jax.vmap(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> sa, sb: lift2(sa, sb, effort_a, effort_b, model_features)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        )(strength_a, strength_b)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(outcomes)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> lift2(strength_a, strength_b, effort_a, effort_b, model_features)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> joint_utility_multiple_strength(strength_a, strength_b, effort_a, effort_b, model_features):</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute utilities for both agents given multiple fixed strengths and efforts.</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: (utility_a, utility_b, success_prob)</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    reward <span class="op">=</span> high_reward  <span class="co"># Round 3 uses high reward</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> outcome2(strength_a, strength_b, effort_a, effort_b, model_features<span class="op">=</span>model_features)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    gini_coef <span class="op">=</span> jax.lax.cond(</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        ModelFeatures.GINI <span class="kw">in</span> model_features,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: gini(effort_a, effort_b),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> _: np.array(<span class="fl">0.0</span>),</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        operand<span class="op">=</span><span class="va">None</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    utility_a <span class="op">=</span> reward <span class="op">*</span> success <span class="op">-</span> alpha <span class="op">*</span> effort_a <span class="op">-</span> beta <span class="op">*</span> gini_coef</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    utility_b <span class="op">=</span> reward <span class="op">*</span> success <span class="op">-</span> alpha <span class="op">*</span> effort_b <span class="op">-</span> beta <span class="op">*</span> gini_coef</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> utility_a, utility_b, success</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> best_response_a(strength_a, strength_b, effort_b, model_features):</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co">    Find agent A's best response to agent B's effort.</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="co">    Agent A optimizes: max_{e_a} E[utility_a(e_a, e_b) | s_a, s_b]</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    utilities <span class="op">=</span> jax.vmap(</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> ea: joint_utility_multiple_strength(strength_a, strength_b, ea, effort_b, model_features<span class="op">=</span>model_features)[<span class="dv">0</span>]</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    )(efforts)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> efforts[np.argmax(utilities)]</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>[<span class="st">'model_features'</span>])</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> best_response_b(strength_a, strength_b, effort_a, model_features):</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Find agent B's best response to agent A's effort.</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    utilities <span class="op">=</span> jax.vmap(</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> eb: joint_utility_multiple_strength(strength_a, strength_b, effort_a, eb, model_features<span class="op">=</span>model_features)[<span class="dv">1</span>]</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    )(efforts)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> efforts[np.argmax(utilities)]</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_equilibrium(strength_a, strength_b, init_effort, model_features, max_depth<span class="op">=</span><span class="dv">10</span>, verbose<span class="op">=</span><span class="va">False</span>, trace<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="co">    Find Nash equilibrium through mutually recursive best responses.</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="co">    This implementation EXACTLY matches the WebPPL version's recursive structure:</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co">    - a(depth, reward) calls b(depth-1, reward)</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co">    - b(depth, reward) calls a(depth, reward) if depth &gt; 0, else uses init_effort</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="co">    - Convergence checked using findDepth() at specific depths [1, 2, 5, 10]</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="co">        strength_a: Agent A's strength (scalar or array)</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a><span class="co">        strength_b: Agent B's strength (scalar or array)</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a><span class="co">        init_effort: Initial effort for agent B at depth=0</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a><span class="co">        max_depth: Maximum recursion depth</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a><span class="co">        verbose: Print convergence info</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="co">        trace: Print detailed trace of recursive calls</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a><span class="co">        (effort_a, effort_b, converged_depth)</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    reward <span class="op">=</span> high_reward  <span class="co"># Round 3 reward (matches WebPPL r3_reward)</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cache for memoizing recursive calls (mimics WebPPL's call stack behavior)</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    cache_a <span class="op">=</span> {}</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    cache_b <span class="op">=</span> {}</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> a(depth):</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Agent A's best response at given recursion depth."""</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth <span class="kw">in</span> cache_a:</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cache_a[depth]</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get B's effort from one level down</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        effort_b <span class="op">=</span> b(depth <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trace:</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  a(depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">): B's effort from b(</span><span class="sc">{</span>depth<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">) = </span><span class="sc">{</span>effort_b<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A optimizes given B's effort</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        effort_a <span class="op">=</span> best_response_a(strength_a, strength_b, effort_b, model_features)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trace:</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  a(depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">): A's best response = </span><span class="sc">{</span>effort_a<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>        cache_a[depth] <span class="op">=</span> effort_a</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> effort_a</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> b(depth):</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Agent B's best response at given recursion depth."""</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth <span class="kw">in</span> cache_b:</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cache_b[depth]</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Base case: depth 0 uses initial effort</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> trace:</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  b(depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">): Using init_effort = </span><span class="sc">{</span>init_effort<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>            cache_b[depth] <span class="op">=</span> init_effort</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> init_effort</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get A's effort from same level</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        effort_a <span class="op">=</span> a(depth)</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trace:</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  b(depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">): A's effort from a(</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">) = </span><span class="sc">{</span>effort_a<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># B optimizes given A's effort</span></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>        effort_b <span class="op">=</span> best_response_b(strength_a, strength_b, effort_a, model_features)</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trace:</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  b(depth=</span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">): B's best response = </span><span class="sc">{</span>effort_b<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>        cache_b[depth] <span class="op">=</span> effort_b</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> effort_b</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> findDepth(x):</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if convergence achieved at depth x (matches WebPPL logic)."""</span></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>        b_at_x <span class="op">=</span> b(x)</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>        b_at_x_plus_1 <span class="op">=</span> b(x <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>        converged <span class="op">=</span> np.<span class="bu">abs</span>(b_at_x <span class="op">-</span> b_at_x_plus_1) <span class="op">&lt;</span> <span class="fl">0.06</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trace:</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"findDepth(</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">): b(</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">)=</span><span class="sc">{</span>b_at_x<span class="sc">:.4f}</span><span class="ss">, b(</span><span class="sc">{</span>x<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">)=</span><span class="sc">{</span>b_at_x_plus_1<span class="sc">:.4f}</span><span class="ss">, diff=</span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">abs</span>(b_at_x <span class="op">-</span> b_at_x_plus_1)<span class="sc">:.4f}</span><span class="ss">, converged=</span><span class="sc">{</span>converged<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x <span class="cf">if</span> converged <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try depths in order [1, 2, 5, 10] (matches WebPPL ds array)</span></span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>    candidate_depths <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>]</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> trace:</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== find_equilibrium(init_effort=</span><span class="sc">{</span>init_effort<span class="sc">:.4f}</span><span class="ss">) ==="</span>)</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> depth_candidate <span class="kw">in</span> candidate_depths:</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth_candidate <span class="op">&gt;</span> max_depth:</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> findDepth(depth_candidate)</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Converged at this depth</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Return efforts from depth+1 for A, depth for B (matches WebPPL lines 209-210)</span></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>            effort_a <span class="op">=</span> a(result <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>            effort_b <span class="op">=</span> b(result)</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose:</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  Converged at depth </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">: effort_a=</span><span class="sc">{</span>effort_a<span class="sc">:.4f}</span><span class="ss">, effort_b=</span><span class="sc">{</span>effort_b<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> effort_a, effort_b, result</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Did not converge</span></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Warning: Effort could not converge in </span><span class="sc">{</span>candidate_depths[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss"> iterations"</span>)</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>    effort_a <span class="op">=</span> a(candidate_depths[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>    effort_b <span class="op">=</span> b(candidate_depths[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> effort_a, effort_b, candidate_depths[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a><span class="co"># To find the optimal initial effort, we'd search over init_effort values</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> starting_effort(posterior_sa, posterior_sb, model_features):</span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a><span class="co">    Find initial effort that maximizes expected joint utility.</span></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a><span class="co">    This matches the WebPPL startingEffort() function which optimizes jointU.</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a><span class="co">        posterior_sa - sampled from posterior</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a><span class="co">        posterior_sb - sampled from posterior</span></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a><span class="co">        Optimal initial effort value</span></span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>    joint_utilities <span class="op">=</span> []</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> init_effort <span class="kw">in</span> efforts:</span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> expected_joint_utility(init_effort, posterior_sa, posterior_sb, model_features<span class="op">=</span>model_features)</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>        joint_utilities.append(stats[<span class="st">'jointU'</span>])  <span class="co"># Optimize joint utility (matches WebPPL)</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>    joint_utilities <span class="op">=</span> np.array(joint_utilities)</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> efforts[np.argmax(joint_utilities)]</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> expected_joint_utility(init_effort, posterior_sa, posterior_sb, model_features):</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute expected utilities and efforts over posterior distribution of strengths.</span></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a><span class="co">    This matches the WebPPL jointUtility() function output, computing expectations over</span></span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a><span class="co">    the posterior distribution of agent strengths.</span></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a><span class="co">        posterior_sa: sampled from posterior</span></span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a><span class="co">        posterior_sb: sampled from posterior</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a><span class="co">        init_effort: Initial effort for agent B to start equilibrium search</span></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a><span class="co">        dict with keys: joint_utility, agent_a_utility, agent_b_utility,</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a><span class="co">                       agent_a_effort, agent_b_effort, outcome_prob</span></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute expectations by averaging over samples</span></span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>    effort_a, effort_b, depth <span class="op">=</span> find_equilibrium(posterior_sa, posterior_sb, init_effort, model_features)</span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f"Strengths (A={posterior_sa:.2f}, B={posterior_sb:.2f}): Efforts (A={effort_a:.4f}, B={effort_b:.4f})")</span></span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute utilities and outcome at equilibrium</span></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>    utility_a, utility_b, success_prob <span class="op">=</span> joint_utility_multiple_strength(posterior_sa, posterior_sb, effort_a, effort_b, model_features<span class="op">=</span>model_features)</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test equilibrium finding with a sample strength pair</span></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (init_effort <span class="op">==</span> <span class="fl">0.0</span> <span class="kw">or</span> <span class="kw">not</span> (ModelFeatures.GINI <span class="kw">in</span> model_features)) <span class="kw">and</span> DEBUG:</span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== EQUILIBRIUM FINDING (init_effort=</span><span class="sc">{</span>init_effort<span class="sc">}</span><span class="ss">, sample strength pair) ==="</span>)</span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Convergence depth: </span><span class="sc">{</span>depth<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Agent A equilibrium effort: </span><span class="sc">{</span>effort_a<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Agent B equilibrium effort: </span><span class="sc">{</span>effort_b<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>        <span class="st">'jointU'</span>: utility_a <span class="op">+</span> utility_b,</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aU'</span>: utility_a,</span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bU'</span>: utility_b,</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aE'</span>: effort_a,</span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bE'</span>: effort_b,</span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>        <span class="st">'P'</span>: outcome2(posterior_sa, posterior_sb, effort_a, effort_b, model_features<span class="op">=</span>model_features)</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a><span class="co"># for solitary/compensatory effort models</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> independent_effort_optimization(others_effort, posterior_sa, posterior_sb):</span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute efforts when each agent independently optimizes assuming </span></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a><span class="co">    partner uses a fixed effort level (solitary=0, compensatory=1).</span></span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a><span class="co">    This is NOT game-theoretic - no mutual best response.</span></span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a><span class="co">    Each agent simply optimizes: max_{e} E[U(e, others_effort)]</span></span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Agent A optimizes assuming B uses others_effort</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>    utilities_a <span class="op">=</span> jax.vmap(</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> ea: joint_utility_multiple_strength(</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>            posterior_sa, posterior_sb, ea, others_effort, model_features<span class="op">=</span>ModelFeatures.NONE</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">0</span>]  <span class="co"># Get utility_a</span></span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>    )(efforts)</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>    effort_a <span class="op">=</span> efforts[np.argmax(utilities_a)]</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Agent B optimizes assuming A uses others_effort  </span></span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>    utilities_b <span class="op">=</span> jax.vmap(</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> eb: joint_utility_multiple_strength(</span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>            posterior_sa, posterior_sb, others_effort, eb, model_features<span class="op">=</span>ModelFeatures.NONE</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>        )[<span class="dv">1</span>]  <span class="co"># Get utility_b</span></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    )(efforts)</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>    effort_b <span class="op">=</span> efforts[np.argmax(utilities_b)]</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute final statistics with these independent efforts</span></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>    utility_a, utility_b, success_prob <span class="op">=</span> joint_utility_multiple_strength(</span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>        posterior_sa, posterior_sb, effort_a, effort_b, model_features<span class="op">=</span>ModelFeatures.NONE</span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>        <span class="st">'jointU'</span>: utility_a <span class="op">+</span> utility_b,</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aU'</span>: utility_a,</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bU'</span>: utility_b,</span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aE'</span>: effort_a,</span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bE'</span>: effort_b,</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>        <span class="st">'P'</span>: success_prob</span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="running-the-model-for-a-scenario" class="level2">
<h2 class="anchored" data-anchor-id="running-the-model-for-a-scenario">Running the Model for a Scenario</h2>
<div id="93cb6a74" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, r1_outcome_a, r1_outcome_b, r2_outcome_a, r2_outcome_b):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Get posterior over strengths</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Computing posterior over agent strengths..."</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        posterior_strengths <span class="op">=</span> infer_strengths(r1_outcome_a, r1_outcome_b, r2_outcome_a, r2_outcome_b)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># DEBUG: Bayesian inference statistics</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== BAYESIAN INFERENCE STATISTICS ==="</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            posterior_2d <span class="op">=</span> posterior_strengths.reshape(<span class="bu">len</span>(strength_values), <span class="bu">len</span>(strength_values))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Posterior shape: </span><span class="sc">{</span>posterior_2d<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Number of non-negligible posterior samples (compare to WebPPL): </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(posterior_strengths <span class="op">&gt;</span> <span class="fl">1e-10</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Total probability mass: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(posterior_2d)<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute marginals</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>            marginal_a <span class="op">=</span> np.<span class="bu">sum</span>(posterior_2d, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            marginal_b <span class="op">=</span> np.<span class="bu">sum</span>(posterior_2d, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute statistics</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            mean_sa <span class="op">=</span> np.<span class="bu">sum</span>(marginal_a <span class="op">*</span> strength_values)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            mean_sb <span class="op">=</span> np.<span class="bu">sum</span>(marginal_b <span class="op">*</span> strength_values)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent A strength - mean: </span><span class="sc">{</span>mean_sa<span class="sc">:.4f}</span><span class="ss">, min: </span><span class="sc">{</span>strength_values[<span class="dv">0</span>]<span class="sc">:.4f}</span><span class="ss">, max: </span><span class="sc">{</span>strength_values[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent B strength - mean: </span><span class="sc">{</span>mean_sb<span class="sc">:.4f}</span><span class="ss">, min: </span><span class="sc">{</span>strength_values[<span class="dv">0</span>]<span class="sc">:.4f}</span><span class="ss">, max: </span><span class="sc">{</span>strength_values[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find high-probability regions</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            high_prob_threshold <span class="op">=</span> np.<span class="bu">max</span>(posterior_2d) <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            high_prob_indices <span class="op">=</span> np.where(posterior_2d <span class="op">&gt;</span> high_prob_threshold)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"High probability region (top 10%): strength_a in [</span><span class="sc">{</span>strength_values[np.<span class="bu">min</span>(high_prob_indices[<span class="dv">0</span>])]<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>strength_values[np.<span class="bu">max</span>(high_prob_indices[<span class="dv">0</span>])]<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"                                     strength_b in [</span><span class="sc">{</span>strength_values[np.<span class="bu">min</span>(high_prob_indices[<span class="dv">1</span>])]<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>strength_values[np.<span class="bu">max</span>(high_prob_indices[<span class="dv">1</span>])]<span class="sc">:.2f}</span><span class="ss">]"</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Find the actual support of the posterior (non-zero probability mass)</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            posterior_support <span class="op">=</span> posterior_2d <span class="op">&gt;</span> <span class="fl">1e-10</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            support_indices <span class="op">=</span> np.where(posterior_support)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(support_indices[<span class="dv">0</span>]) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Non-negligible posterior support:"</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  strength_a in [</span><span class="sc">{</span>strength_values[np.<span class="bu">min</span>(support_indices[<span class="dv">0</span>])]<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>strength_values[np.<span class="bu">max</span>(support_indices[<span class="dv">0</span>])]<span class="sc">:.2f}</span><span class="ss">], with mean </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(marginal_a <span class="op">*</span> strength_values)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  strength_b in [</span><span class="sc">{</span>strength_values[np.<span class="bu">min</span>(support_indices[<span class="dv">1</span>])]<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>strength_values[np.<span class="bu">max</span>(support_indices[<span class="dv">1</span>])]<span class="sc">:.2f}</span><span class="ss">], with mean </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(marginal_b <span class="op">*</span> strength_values)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">WARNING: Posterior has no support! Inference may have failed."</span>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.posterior <span class="op">=</span> posterior_strengths.reshape(<span class="bu">len</span>(strength_values), <span class="bu">len</span>(strength_values))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assert that probabilities above 1e-10 all are the same</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        unique_probs <span class="op">=</span> np.unique(<span class="va">self</span>.posterior[<span class="va">self</span>.posterior <span class="op">&gt;</span> <span class="fl">1e-10</span>])</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(unique_probs) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">ERROR: Posterior probabilities vary! This WILL affect sampling accuracy."</span>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Unique non-negligible posterior probabilities: </span><span class="sc">{</span>unique_probs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="bu">len</span>(unique_probs) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Posterior probabilities vary above threshold!"</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if probs vary, would need to use a larger number of samples, to approximate the samples correctly, e.g.: </span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># num_samples = int(prob * 1000)</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># posterior_sb.extend([sb] * num_samples)</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># posterior_sa.extend([sa] * num_samples)</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Convert from posterior point probabilities to posterior samples</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (there should be sample counts proportional to the posterior probabilities)</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        posterior_sa <span class="op">=</span> []</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        posterior_sb <span class="op">=</span> []</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, sa <span class="kw">in</span> <span class="bu">enumerate</span>(strength_values):</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, sb <span class="kw">in</span> <span class="bu">enumerate</span>(strength_values):</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>                prob <span class="op">=</span> <span class="va">self</span>.posterior[i, j]</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prob <span class="op">&gt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>                    posterior_sa.extend([sa] <span class="op">*</span> <span class="dv">1</span>)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>                    posterior_sb.extend([sb] <span class="op">*</span> <span class="dv">1</span>)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.posterior_sa <span class="op">=</span> np.array(posterior_sa)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.posterior_sb <span class="op">=</span> np.array(posterior_sb)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"First 5 samples (sa, sb): </span><span class="sc">{</span>np<span class="sc">.</span>array(<span class="bu">list</span>(<span class="bu">zip</span>(<span class="bu">list</span>(<span class="bu">reversed</span>(<span class="va">self</span>.posterior_sa))[:<span class="dv">5</span>], <span class="bu">list</span>(<span class="bu">reversed</span>(<span class="va">self</span>.posterior_sb))[:<span class="dv">5</span>])))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ^reverse for the sake of matching the order by which webppl enumerates</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _check_stats(<span class="va">self</span>, stats):</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== FINAL RESULTS ==="</span>)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>, <span class="st">'optimal_init_effort'</span>):</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Optimal starting effort: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>optimal_init_effort<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Joint utility at optimum: </span><span class="sc">{</span>stats[<span class="st">'jointU'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent A utility: </span><span class="sc">{</span>stats[<span class="st">'aU'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent B utility: </span><span class="sc">{</span>stats[<span class="st">'bU'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent A equilibrium effort: </span><span class="sc">{</span>stats[<span class="st">'aE'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Agent B equilibrium effort: </span><span class="sc">{</span>stats[<span class="st">'bE'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Expected outcome probability: </span><span class="sc">{</span>stats[<span class="st">'P'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">(Compare to original WebPPL output)"</span>)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sanity check: joint utility should equal sum of individual utilities</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        joint_check <span class="op">=</span> stats[<span class="st">'aU'</span>] <span class="op">+</span> stats[<span class="st">'bU'</span>]</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(joint_check <span class="op">-</span> stats[<span class="st">'jointU'</span>]) <span class="op">&gt;</span> <span class="fl">1e-5</span>:</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"WARNING: Joint utility mismatch! </span><span class="sc">{</span>stats[<span class="st">'jointU'</span>]<span class="sc">:.6f}</span><span class="ss"> != </span><span class="sc">{</span>joint_check<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> joint_effort(<span class="va">self</span>, model_features<span class="op">=</span>ModelFeatures.GINI):</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find optimal initial effort (by searching over effort space)</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== FINDING OPTIMAL INITIAL EFFORT ==="</span>)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimal_init_effort <span class="op">=</span> starting_effort(<span class="va">self</span>.posterior_sa, <span class="va">self</span>.posterior_sb, model_features<span class="op">=</span>model_features)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Using initial effort: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>optimal_init_effort<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute expected statistics at equilibrium (utilities, efforts, outcome)</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> DEBUG:</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Computing expected statistics at equilibrium..."</span>)</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> expected_joint_utility(<span class="va">self</span>.optimal_init_effort, <span class="va">self</span>.posterior_sa, <span class="va">self</span>.posterior_sb, model_features<span class="op">=</span>model_features)</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._check_stats(stats)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> stats</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compensatory_effort(<span class="va">self</span>):</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> independent_effort_optimization(</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>            others_effort<span class="op">=</span><span class="fl">1.0</span>,  <span class="co"># Assume partner uses maximum effort</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>            posterior_sa<span class="op">=</span><span class="va">self</span>.posterior_sa,</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>            posterior_sb<span class="op">=</span><span class="va">self</span>.posterior_sb</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._check_stats(stats)</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> stats</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> solitary_effort(<span class="va">self</span>):</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> independent_effort_optimization(</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>            others_effort<span class="op">=</span><span class="fl">0.0</span>,  <span class="co"># Assume partner contributes nothing</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>            posterior_sa<span class="op">=</span><span class="va">self</span>.posterior_sa,</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>            posterior_sb<span class="op">=</span><span class="va">self</span>.posterior_sb</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._check_stats(stats)</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1c2a7a13" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>).joint_effort()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>).solitary_effort()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>).compensatory_effort()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="visualization-of-inferred-strength" class="level3">
<h3 class="anchored" data-anchor-id="visualization-of-inferred-strength">Visualization of inferred strength</h3>
<div id="bfb9dd6a" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sample_model <span class="op">=</span> Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize posterior over agent strengths</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior heatmap</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> axes[<span class="dv">0</span>].imshow(sample_model.posterior, origin<span class="op">=</span><span class="st">'lower'</span>, extent<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">1</span>, <span class="dv">10</span>], aspect<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Agent B Strength'</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Agent A Strength'</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Posterior P(strength_A, strength_B | F,F;F,F)'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, ax<span class="op">=</span>axes[<span class="dv">0</span>], label<span class="op">=</span><span class="st">'Probability'</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal distributions</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>marginal_a <span class="op">=</span> np.<span class="bu">sum</span>(sample_model.posterior, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>marginal_b <span class="op">=</span> np.<span class="bu">sum</span>(sample_model.posterior, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(strength_values, marginal_a, label<span class="op">=</span><span class="st">'Agent A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(strength_values, marginal_b, label<span class="op">=</span><span class="st">'Agent B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Strength'</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Probability'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Marginal Distributions'</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computing posterior over agent strengths...
 --&gt; infer_strengths((0.0, 0.0, 0.0, 0.0))
&lt;--  infer_strengths((0.0, 0.0, 0.0, 0.0)) has shape (301, 301)
     time = 0.206284 sec

=== BAYESIAN INFERENCE STATISTICS ===
Posterior shape: (301, 301)
Number of non-negligible posterior samples (compare to WebPPL): 17956
Total probability mass: 1.000003
Agent A strength - mean: 2.9950, min: 1.0000, max: 10.0000
Agent B strength - mean: 2.9950, min: 1.0000, max: 10.0000
High probability region (top 10%): strength_a in [1.00, 4.99]
                                     strength_b in [1.00, 4.99]
Non-negligible posterior support:
  strength_a in [1.00, 4.99], with mean 2.99
  strength_b in [1.00, 4.99], with mean 2.99
First 5 samples (sa, sb): [[4.9900002 4.9900002]
 [4.9900002 4.96     ]
 [4.9900002 4.9300003]
 [4.9900002 4.9      ]
 [4.9900002 4.8700004]]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="xiang2023-exp1-round3-memo_files/figure-html/cell-9-output-2.png" width="1429" height="564" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="compute-predictions-for-all-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="compute-predictions-for-all-scenarios">Compute predictions for all scenarios</h2>
<div id="d18c9130" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>DEBUG <span class="op">=</span> <span class="va">False</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F,F;F,F"</span>: Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F,F;F,L"</span>: Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F,F;L,L"</span>: Model(<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F,L;F,L"</span>: Model(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F,L;L,L"</span>: Model(<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"L,L;L,L"</span>: Model(<span class="fl">1.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>model_fits <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>model_fits[<span class="st">'joint'</span>] <span class="op">=</span> {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    scenario: model.joint_effort()</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scenario, model <span class="kw">in</span> models.items()</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>model_fits[<span class="st">'compensatory'</span>] <span class="op">=</span> {</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    scenario: model.compensatory_effort()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scenario, model <span class="kw">in</span> models.items()</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>model_fits[<span class="st">'solitary'</span>] <span class="op">=</span> {</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    scenario: model.solitary_effort()</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scenario, model <span class="kw">in</span> models.items()</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co"># to replicate competence_effort/Code/supplement/variations_of_joint_model/exp1_simulation.R</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>model_fits[<span class="st">'joint_wo_gini'</span>] <span class="op">=</span> {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    scenario: model.joint_effort(ModelFeatures.NONE)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scenario, model <span class="kw">in</span> models.items()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>model_fits[<span class="st">'safe_joint_w_gini'</span>] <span class="op">=</span> {</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    scenario: model.joint_effort(ModelFeatures.GINI <span class="op">|</span> ModelFeatures.SAFE)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> scenario, model <span class="kw">in</span> models.items()</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> --&gt; infer_strengths((0.0, 0.0, 0.0, 0.0))
&lt;--  infer_strengths((0.0, 0.0, 0.0, 0.0)) has shape (301, 301)
     time = 0.000891 sec
 --&gt; infer_strengths((0.0, 0.0, 0.0, 1.0))
&lt;--  infer_strengths((0.0, 0.0, 0.0, 1.0)) has shape (301, 301)
     time = 0.000664 sec
 --&gt; infer_strengths((0.0, 0.0, 1.0, 1.0))
&lt;--  infer_strengths((0.0, 0.0, 1.0, 1.0)) has shape (301, 301)
     time = 0.000746 sec
 --&gt; infer_strengths((0.0, 1.0, 0.0, 1.0))
&lt;--  infer_strengths((0.0, 1.0, 0.0, 1.0)) has shape (301, 301)
     time = 0.000676 sec
 --&gt; infer_strengths((0.0, 1.0, 1.0, 1.0))
&lt;--  infer_strengths((0.0, 1.0, 1.0, 1.0)) has shape (301, 301)
     time = 0.000455 sec
 --&gt; infer_strengths((1.0, 1.0, 1.0, 1.0))
&lt;--  infer_strengths((1.0, 1.0, 1.0, 1.0)) has shape (301, 301)
     time = 0.000481 sec</code></pre>
</div>
</div>
<div id="d05712d7" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert model fits to DataFrame for easier manipulation, converting key (e.g. "joint") to a column called "model"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>model_fits_df <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    {(model, scenario): data </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span> model, scenarios <span class="kw">in</span> model_fits.items() </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>     <span class="cf">for</span> scenario, data <span class="kw">in</span> scenarios.items()},</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    orient<span class="op">=</span><span class="st">'index'</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>model_fits_df.rename(columns<span class="op">=</span>{<span class="st">'level_0'</span>: <span class="st">'model'</span>, <span class="st">'level_1'</span>: <span class="st">'scenario'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>model_fits_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">scenario</th>
<th data-quarto-table-cell-role="th">jointU</th>
<th data-quarto-table-cell-role="th">aU</th>
<th data-quarto-table-cell-role="th">bU</th>
<th data-quarto-table-cell-role="th">aE</th>
<th data-quarto-table-cell-role="th">bE</th>
<th data-quarto-table-cell-role="th">P</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>joint</td>
<td>F,F;F,F</td>
<td>1.7502766</td>
<td>0.8751383</td>
<td>0.8751383</td>
<td>1.0</td>
<td>1.0</td>
<td>0.7187569</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>joint</td>
<td>F,F;F,L</td>
<td>17.172792</td>
<td>10.273896</td>
<td>6.8988967</td>
<td>0.5</td>
<td>0.75</td>
<td>0.9124448</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>joint</td>
<td>F,F;L,L</td>
<td>26.5</td>
<td>13.25</td>
<td>13.25</td>
<td>0.5</td>
<td>0.5</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>joint</td>
<td>F,L;F,L</td>
<td>22.803928</td>
<td>13.089464</td>
<td>9.714463</td>
<td>0.35</td>
<td>0.6</td>
<td>0.97131526</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>joint</td>
<td>F,L;L,L</td>
<td>28.812677</td>
<td>14.406339</td>
<td>14.406339</td>
<td>0.4</td>
<td>0.4</td>
<td>0.9903169</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>joint</td>
<td>L,L;L,L</td>
<td>30.550003</td>
<td>15.275002</td>
<td>15.275002</td>
<td>0.35</td>
<td>0.35</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>compensatory</td>
<td>F,F;F,F</td>
<td>-1.918592</td>
<td>-0.959296</td>
<td>-0.959296</td>
<td>0.85</td>
<td>0.85</td>
<td>0.52578527</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>compensatory</td>
<td>F,F;F,L</td>
<td>-8.775</td>
<td>0.0</td>
<td>-8.775</td>
<td>0.0</td>
<td>0.65</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>compensatory</td>
<td>F,F;L,L</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>compensatory</td>
<td>F,L;F,L</td>
<td>-6.333333</td>
<td>0.20833334</td>
<td>-6.5416665</td>
<td>0.0</td>
<td>0.5</td>
<td>0.010416666</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>compensatory</td>
<td>F,L;L,L</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>compensatory</td>
<td>L,L;L,L</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>solitary</td>
<td>F,F;F,F</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>solitary</td>
<td>F,F;F,L</td>
<td>26.5</td>
<td>20.0</td>
<td>6.5</td>
<td>0.0</td>
<td>1.0</td>
<td>0.99999994</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>solitary</td>
<td>F,F;L,L</td>
<td>13.0</td>
<td>6.5</td>
<td>6.5</td>
<td>1.0</td>
<td>1.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>solitary</td>
<td>F,L;F,L</td>
<td>30.55</td>
<td>20.0</td>
<td>10.55</td>
<td>0.0</td>
<td>0.7</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>solitary</td>
<td>F,L;L,L</td>
<td>17.050001</td>
<td>6.5000005</td>
<td>10.550001</td>
<td>1.0</td>
<td>0.7</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>solitary</td>
<td>L,L;L,L</td>
<td>21.100002</td>
<td>10.550001</td>
<td>10.550001</td>
<td>0.7</td>
<td>0.7</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>joint_wo_gini</td>
<td>F,F;F,F</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>joint_wo_gini</td>
<td>F,F;F,L</td>
<td>26.5</td>
<td>20.0</td>
<td>6.5</td>
<td>0.0</td>
<td>1.0</td>
<td>0.99999994</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>joint_wo_gini</td>
<td>F,F;L,L</td>
<td>26.5</td>
<td>6.5</td>
<td>20.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>joint_wo_gini</td>
<td>F,L;F,L</td>
<td>30.55</td>
<td>20.0</td>
<td>10.55</td>
<td>0.0</td>
<td>0.7</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>joint_wo_gini</td>
<td>F,L;L,L</td>
<td>30.550001</td>
<td>20.0</td>
<td>10.550001</td>
<td>0.0</td>
<td>0.7</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>joint_wo_gini</td>
<td>L,L;L,L</td>
<td>30.550003</td>
<td>11.225001</td>
<td>19.325</td>
<td>0.65</td>
<td>0.05</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>safe_joint_w_gini</td>
<td>F,F;F,F</td>
<td>1.7502766</td>
<td>0.8751383</td>
<td>0.8751383</td>
<td>1.0</td>
<td>1.0</td>
<td>0.7187569</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>safe_joint_w_gini</td>
<td>F,F;F,L</td>
<td>15.163114</td>
<td>7.9190564</td>
<td>7.244057</td>
<td>0.85</td>
<td>0.9</td>
<td>0.9784528</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>safe_joint_w_gini</td>
<td>F,F;L,L</td>
<td>21.02065</td>
<td>10.510325</td>
<td>10.510325</td>
<td>0.7</td>
<td>0.7</td>
<td>0.99801624</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>safe_joint_w_gini</td>
<td>F,L;F,L</td>
<td>18.397388</td>
<td>9.198694</td>
<td>9.198694</td>
<td>0.75</td>
<td>0.75</td>
<td>0.9661847</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>safe_joint_w_gini</td>
<td>F,L;L,L</td>
<td>22.635002</td>
<td>11.655001</td>
<td>10.980001</td>
<td>0.6</td>
<td>0.65</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>safe_joint_w_gini</td>
<td>L,L;L,L</td>
<td>24.407814</td>
<td>12.203907</td>
<td>12.203907</td>
<td>0.55</td>
<td>0.55</td>
<td>0.9814453</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="c596c949" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save to csv</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>model_fits_df.to_csv(<span class="st">'xiang2023-exp1-round3-model_fits_results.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="notes-on-conversion-strategy" class="level2">
<h2 class="anchored" data-anchor-id="notes-on-conversion-strategy">Notes on Conversion Strategy</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Disclaimer: Large portions of this section were written in collaboration with Claude Code and verified and edited for accuracy by the author. Of course, author takes responsibility for any inaccuracies and strongly welcomes corrections.</p>
</div>
</div>
<p>The conversion from WebPPL to memo revealed important distinctions:</p>
<section id="probabilistic-inference-vs.-decision-theory" class="level3">
<h3 class="anchored" data-anchor-id="probabilistic-inference-vs.-decision-theory">1. Probabilistic Inference vs.&nbsp;Decision Theory</h3>
<p>The original WebPPL code mixes two types of reasoning:</p>
<ul>
<li><strong>Bayesian inference</strong> (rounds 1-2): Infer agent strengths from observed outcomes</li>
<li><strong>Game-theoretic optimization</strong> (round 3): Find Nash equilibrium efforts</li>
</ul>
<p>In the memo conversion:</p>
<ul>
<li><strong>Bayesian inference</strong>: Use <code>@memo</code> with <code>given()</code>, <code>observes_that[]</code>, and <code>thinks[]</code></li>
<li><strong>Game-theoretic optimization</strong>: Use pure JAX functions (no probabilistic reasoning, just optimization)</li>
</ul>
</section>
<section id="key-conversion-decisions" class="level3">
<h3 class="anchored" data-anchor-id="key-conversion-decisions">2. Key Conversion Decisions</h3>
<p><strong>Mutable arrays (x2a, x2b)</strong>:</p>
<ul>
<li>WebPPL: Pushes strength posterior samples to arrays, uses them later</li>
<li>memo: Query the posterior distribution directly (more principled)</li>
</ul>
<p><strong>Nested agent reasoning</strong>:</p>
<ul>
<li>WebPPL: Nested JavaScript functions with recursive best-response</li>
<li>JAX: Iterative best-response in pure JAX (not probabilistic, so no <code>thinks[]</code> needed here)</li>
</ul>
<p><strong>Expected utilities</strong>:</p>
<ul>
<li>WebPPL: Implicitly handles through sampling or enumeration</li>
<li>JAX: Explicit loop over posterior, computing equilibrium for each strength pair</li>
</ul>
</section>
<section id="computational-considerations" class="level3">
<h3 class="anchored" data-anchor-id="computational-considerations">3. Computational Considerations</h3>
<p>The original uses either:</p>
<ul>
<li>MCMC with 10,000 samples (slow but handles continuous distributions)</li>
<li>Enumeration with discrete values (exact but potentially more expensive)</li>
</ul>
</section>
<section id="what-could-be-improved" class="level3">
<h3 class="anchored" data-anchor-id="what-could-be-improved">4. What Could Be Improved</h3>
<p><strong>Further extension with memo</strong>:</p>
<p>Currently, the game-theoretic reasoning is outside of <code>@memo</code>. One could potentially:</p>
<ul>
<li>Model agentsâ€™ beliefs about each otherâ€™s strengths using nested <code>thinks[]</code></li>
<li>Model agentsâ€™ choices as <code>chooses(e in efforts, wpp=utility(e))</code></li>
<li>But this might be overkill and harder to reason about</li>
<li>However, this does incorporate uncertainty about the other agent into the model, which might add richness</li>
</ul>
</section>
</section>
<section id="how-to-compare-outputs" class="level2">
<h2 class="anchored" data-anchor-id="how-to-compare-outputs">How to Compare Outputs</h2>
<p>(Also see <code>TRACING_GUIDE.md</code>)</p>
<p>To verify that the WebPPL and memo implementations produce the same results:</p>
<p>These should match (up to numerical precision and discretization choices).</p>
<p>Compare outcome probability (here, <code>expected_outcome</code>), strength posteriors, and joint utility results for r3 outcome and for starting effort.</p>
<ol type="1">
<li><strong>Expected matches:</strong>
<ul>
<li>Helper functions (lift, optE, outcome) should return identical values for test inputs</li>
<li>Bayesian inference statistics should show similar:
<ul>
<li>Posterior means (agent strengths)</li>
<li>Non-neglible-probability regions</li>
</ul></li>
<li>Equilibrium finding should show similar:
<ul>
<li>Convergence depth (may vary slightly due to discretization)</li>
<li>Equilibrium efforts</li>
</ul></li>
<li>Final outcome probability should be close</li>
</ul></li>
<li><strong>Known differences:</strong>
<ul>
<li>See above</li>
<li>Small numerical differences due to different underlying computation engines</li>
</ul></li>
</ol>
</section>
<section id="notes-on-the-alternative-models" class="level2">
<h2 class="anchored" data-anchor-id="notes-on-the-alternative-models">Notes on the alternative models</h2>
<p>The joint effort model and the solitary/compensatory models are fundamentally different in their computational structure:</p>
<p><strong>Joint Effort Model:</strong></p>
<ul>
<li>Uses game-theoretic Nash equilibrium finding</li>
<li>Agents engage in mutually recursive best-response reasoning</li>
<li>Includes inequality aversion (Gini coefficient with Î²=24.5)</li>
<li>Optimizes <code>init_effort</code> to maximize joint utility</li>
</ul>
<p><strong>Solitary/Compensatory Models:</strong></p>
<ul>
<li>Use independent optimization with <strong>fixed assumption</strong> of partnerâ€™s effort (0 or 1, resp.)</li>
<li>Each agent independently maximizes their utility assuming partner uses fixed effort</li>
<li><strong>No mutual recursion</strong> - direct calculation</li>
<li><strong>No Gini coefficient</strong> - agents donâ€™t care about effort matching</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>